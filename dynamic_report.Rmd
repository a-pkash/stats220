---
title: My dynamic report
output: html_fragment
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo=FALSE, message=FALSE, warning=FALSE, error=FALSE)
library(tidyverse)
```

```{css}

```

## Commute Data Analysis

This report analyses data regarding my commute to/from the University of Auckland 
over the last few weeks. Data on which mode of transport/bus route I took, the 
crowded-ness of the bus, and the start time and duration of my commute was 
collected via a Google Form. This data was analysed using the R techniques taught 
in the Stats 220 course to determine trends and possibly inform suggestions on 
when/how I should commute to and from the University in the future.

```{r}
csv_file <- "https://docs.google.com/spreadsheets/d/e/2PACX-1vTRZ24GyKC8PL-ZaSI4BG6Y9DQVwao8TolkFlGLQr2Fc04ZeyEH2wudkVSBNBde7JGYko3bP3auaHTi/pub?output=csv"

logged_data <- read_csv(csv_file) 


########## PART D: Exploring Data in R ##########
# Rename columns:
latest_data <- logged_data %>%
  rename(
    "direction" = 3, 
    "transport_mode" = 4, 
    "start_time" = 5, 
    "duration" = 6, 
    "bus_route" = 7, 
    "crowded" = 8
    ) %>%
  mutate(start_time_seconds = as.numeric(start_time))

####### Summary values:
## Helper function to format time in seconds (i.e. 30840) into hh:mm:ss (i.e. 08:34:00)
num_to_time <- function(time_in_seconds) {
  hrs <- sprintf("%02d", time_in_seconds %/% 3600)
  mins <- sprintf("%02d", (time_in_seconds %% 3600) %/% 60)
  secs <- sprintf("%02d", time_in_seconds %% 60)
  return(paste0(hrs, ":", mins, ":", secs))
}

## Earliest, latest, shortest, longest trips to/from UoA home
earliest <- num_to_time(min(latest_data$start_time_seconds))
latest <- num_to_time(max(latest_data$start_time_seconds))
shortest <- min(latest_data$duration)
longest <- max(latest_data$duration)

## Average commute duration by mode of transport
avg_duration_by_mode <- latest_data %>%
  group_by(transport_mode) %>%
  summarise(avg_duration = mean(duration, na.rm = TRUE), .groups = "drop")

## Average commute duration by route and direction
avg_duration_by_route <- latest_data %>%
  mutate(bus_route = ifelse(is.na(bus_route), "Car", bus_route)) %>%
  group_by(bus_route, direction) %>%
  summarise(avg_duration = mean(duration), .groups = "drop", 
            avg_start_time = num_to_time(mean(start_time_seconds))) %>%
  arrange(direction, desc(avg_duration))
### Longest bus route overall (on average)
longest_overall <- avg_duration_by_route %>%
  filter(bus_route != "Car") %>%
  filter(avg_duration == max(avg_duration)) 
### Shortest bus route overall (on average)
shortest_overall <- avg_duration_by_route %>%
  filter(bus_route != "Car") %>%
  filter(avg_duration == min(avg_duration)) 

## Crowded-ness and average start time of each bus route based on the direction of travel
busiest_route <- latest_data %>%
  filter(!is.na(bus_route)) %>%
  group_by(bus_route, direction) %>%
  summarise(avg_crowded = mean(crowded, na.rm = TRUE), .groups = "drop",
            avg_start_time = num_to_time(mean(start_time_seconds))) %>%
  arrange(direction, desc(avg_crowded))
### Least crowded UoA to Home
least_crowded_overall <- busiest_route %>%
  group_by(direction) %>%
  arrange(avg_crowded) %>%
  slice(1)
### Most crowded overall
most_crowded_overall <- busiest_route %>%
  group_by(direction) %>%
  arrange(desc(avg_crowded)) %>%
  slice(1)


```


The earliest trip made during the data collection stage was at ```r earliest`, 
and the latest was at  ```r latest`. The shortest trip took ```r shortest` minutes, 
while the longest took ```r longest` minutes.

The collected data also shows that the `r avg_duration_by_mode$transport_mode[1]` 
is faster on average than the `r avg_duration_by_mode$transport_mode[2]` by 
`r abs(round(avg_duration_by_mode$avg_duration[2] - avg_duration_by_mode$avg_duration[1], 2))` 
minutes for my personal commute. 

This is interesting to note, however this figure alone does not provide much insight 
into my commute. Without taking into account factors like the time of my commute 
or the crowded-ness of the bus, I cannot get a good understanding of the trends 
that could inform which route I should take. Hence, we will now consider some of 
these factors:

```{r}
## Avg crowdedness by direction for each bus route
ggplot(busiest_route, aes(x = bus_route, y = avg_crowded, fill = direction)) +
  geom_bar(stat = "identity", position = "dodge") +
  labs(
    title = "Average Crowdedness by Bus Route and Direction",
    x = "Bus Route",
    y = "Average Crowdedness",
    fill = "Direction"
  )
```


As shown above, the trip that is the least crowded on average is the commute from 
`r least_crowded_overall$direction[1]` on the `r least_crowded_overall$bus_route[1]` bus 
route, with an average crowded-ness rating of `r least_crowded_overall$avg_crowded[1]`/5 
(where 1 = Empty Bus, and 5 = Full Bus). The average start time of the recorded 
data from this trip is `r (busiest_route %>% filter(bus_route == least_crowded_overall$bus_route[1], direction == least_crowded_overall$direction[1]))$avg_start_time`

The trip that is the least crowded on average is the commute from 
`r least_crowded_overall$direction[2]` on the `r least_crowded_overall$bus_route[2]` bus 
route, with an average crowded-ness rating of `r least_crowded_overall$avg_crowded[2]`/5. 
The average start time of the recorded 
data from this trip is `r (busiest_route %>% filter(bus_route == least_crowded_overall$bus_route[2], direction == least_crowded_overall$direction[2]))$avg_start_time`

This can inform which bus route to choose in order to commute in the most comfortable 
way. If we compare the crowded-ness to the average duration, we can get more insight 
into the nature of the average commute in a particular direction on a particular bus:

```{r}
## Avg commute duration by bus route and direction
ggplot(avg_duration_by_route, aes(x = bus_route, y = avg_duration, fill = direction)) +
  stat_summary(geom = "bar", position = "dodge") +
  labs(
    title = "Average Travel Duration by Route and Direction",
    x = "Route",
    y = "Average Duration (mins)",
    fill = "Direction"
  ) 

```

From the plot above, we can see that the quickest bus route from `r least_crowded_overall$direction[1]` 
tends to be the `r (avg_duration_by_route %>% filter(bus_route != "Car") %>% group_by(direction) %>% filter(avg_duration == min(avg_duration), direction == least_crowded_overall$direction[1]))$bus_route` which takes `r (avg_duration_by_route %>% filter(bus_route != "Car") %>% group_by(direction) %>% filter(avg_duration == min(avg_duration), direction == least_crowded_overall$direction[1]))$avg_duration` minutes on average, while the 
quickest bus route from `r least_crowded_overall$direction[2]` tends to be the 
`r (avg_duration_by_route %>% filter(bus_route != "Car") %>% group_by(direction) %>% filter(avg_duration == min(avg_duration), direction == least_crowded_overall$direction[2]))$bus_route`, which takes `r (avg_duration_by_route %>% filter(bus_route != "Car") %>% group_by(direction) %>% filter(avg_duration == min(avg_duration), direction == least_crowded_overall$direction[2]))$avg_duration` 
minutes.

These compare to the 




